How to enable multi tenant system and create users, tenants, roles?
==============
Part 1: Enable Multi-Tenancy in Wazuh Dashboard 
Edit the Configuration File: On the Wazuh dashboard node, open the configuration file [/etc/wazuh-dashboard/opensearch_dashboards.yml](url) for editing.
Enable Multi-Tenancy: Add or modify the following lines in the file:
yaml
opensearch_security.multitenancy.enabled: true
opensearch_security.multitenancy.tenants.preferred: ["Global", "Private"]
Restart the Wazuh Dashboard: Apply the changes by restarting the dashboard service:
bash
# systemctl restart wazuh-dashboard
You may also need to clear your browser cache and cookies after restarting. 
Part 2: Create Customer Users and Tenants 
Log into the Wazuh dashboard as an administrator to perform the following steps: 
Create Agent Groups: Create a dedicated agent group for each customer (e.g., CustomerA) under Agents management > Groups. Move the respective agents into these groups.
Add Agent Group Labels: In the configuration files for these groups (e.g., .../shared/CustomerA/agent.conf), add a label to identify them for document-level security. For example:
xml

<agent_config>
  <labels>
    <label key="group">CustomerA</label>
  </labels>
</agent_config>
This ensures that data is filtered correctly for each tenant.
Create a Tenant: Navigate to Indexer management > Security > Tenants and click Create Tenant. Give it a descriptive name (e.g., Tenant_CustomerA).
Create an Internal User: Go to Indexer management > Security > Internal users and click Create internal user. Provide a username and password for the customer's user (e.g., user_customerA).
Create a Role with Document-Level Security (DLS): Go to Indexer management > Security > Roles and click Create role.
Give the role a name (e.g., Role_CustomerA).
Under Cluster Permissions, add cluster_composite_ops_ro.
Under Index Permissions, add a new index permission for wazuh-alerts* with read permissions and a DLS query to filter data based on the label created earlier:
json

{ 
    "bool": { 
        "must": { 
            "match": { 
                "agent.labels.group": "CustomerA" 
            } 
        } 
    } 
}

Repeat the DLS step for the wazuh-monitoring* index.
Under Tenant Permissions, select the previously created Tenant_CustomerA and set permissions to Read only.
Click Create.
Map the User to the Role: In the new role's details, select the Mapped users tab and click Manage mapping. Add the internal user (user_customerA) you created.
Create Wazuh Server Role Mapping: Go to Server management > Security > Roles mapping.
Click Create Role mapping.
Assign a name to the mapping.
In the Roles field, select the relevant Wazuh role (e.g., readonly or a custom-created one with specific policies) and the cluster_readonly role for basic functionality.
In the Internal users field, select the internal user (user_customerA).
Click Save role mapping.
Enable run_as: Ensure that the run_as setting is set to true in the [/usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml](url) file. This allows the Wazuh dashboard to impersonate users to apply RBAC policies correctly. Restart the dashboard service after this change. 



